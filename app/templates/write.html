<html>
<head>
	<title>发布文章</title>
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/alert.min.css') }}">
	<link rel="stylesheet" href="https://npmcdn.com/leaflet@1.0.0-rc.3/dist/leaflet.css" />
	<link rel="stylesheet"  href = "{{ url_for('static', filename='css/write.css') }}">
	{% import "bootstrap/wtf.html" as wtf %}
	{{ pagedown.include_pagedown() }}
	{{ moment.include_moment() }}
</head>

<body>
	{% for message in get_flashed_messages() %}
		<div class="alert alert-warning">
			<a class="close" data-dismiss="alert">&times;</a>
			{{ message }}
		</div>
	{% endfor %}

	{% if current_user.can(Permission.WRITE_ARTICLES) %}
		<div id="container">
			{% for message in get_flashed_messages() %}
		<div class="alert alert-warning">
			<a class="close" data-dismiss="alert">&times;</a>
			{{ message }}
		</div>
	{% endfor %}
		<form action="" method="post" class="form" role="form" enctype=multipart/form-data>
			 {{ form.hidden_tag() }}
			<div class="input-container">
				{{ form.title(class="title", placeholder=form.title.label.text )}}
				<input type="file" name="file" id="file">
				<label for="file">上传主图</label>
			</div>

			<div class="markdown">
				{{ form.body(only_input=True, class="editor") }}
			</div>
			<div class="markdown" id="md-2">
				{{ form.body(only_preview=True) }}
			</div>
			<div id="mapid"></div>

			<div id="submit-row">
				<div id="location">
					{{ form.lat(id="input-lat", class="location-input", placeholder="纬度") }}
					{{ form.long(id="input-lng", class="location-input", placeholder="经度") }}
				</div>
				{{ form.submit(id="submit-button") }}
			</div>

		</form>
		</div>
	{% endif %}

<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-2.2.4.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/alert.min.js') }}"></script>
<script src="https://npmcdn.com/leaflet@1.0.0-rc.2/dist/leaflet.js"></script>
<script>
$( document ).ready(function() {

	$('input[type=file]').change(function() {
		var filename = $('input[type=file]').val().split('\\').pop();
		if (filename.length > 1) {
				$("label").text(filename);
		}
	});


	var mymap = L.map('mapid').setView([39.90, 116.40], 3);
	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
		'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
		'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(mymap);

	{% for post in all_posts %}
		var lat = {{ post.lat }};
		var long = {{ post.long }};
		var title = "{{ post.title }}";
		L.marker([lat, long]).addTo(mymap)
				.bindPopup(title).openPopup();
	{% endfor %}

	var popup = L.popup();

	function onMapClick(e) {
		popup
				.setLatLng(e.latlng)
				.setContent("坐标 ( " + Math.round(e.latlng.lat * 100) / 100 + ", " + Math.round(e.latlng.lng * 100) / 100 + " )")
				.openOn(mymap);
		$("#input-lat").val(e.latlng.lat);
		$("#input-lng").val(e.latlng.lng);
	}

	mymap.on('click', onMapClick);
});

</script>
</body>
</html>